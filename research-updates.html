<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Research Updates Timeline</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #f9fafb;
            margin: 0;
            padding: 2rem;
        }

        /* Timeline container with vertical line */
        .timeline {
            display: flex;
            flex-direction: column;
            position: relative;
            margin-left: 2rem;
            padding-left: 2rem;
            border-left: 2px solid #ccc;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ccc;
        }

        .card {
            position: relative;
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .card::before {
            content: '';
            position: absolute;
            left: -2.5rem;
            top: 1rem;
            width: 10px;
            height: 10px;
            background-color: #0ea5e9;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #ccc;
        }

        .card h2 {
            margin: 0;
            font-size: 1.25rem;
            color: #111827;
        }

        .card h3 {
            margin: 0.25rem 0 0.5rem;
            font-weight: normal;
            color: #6b7280;
        }

        .card p {
            color: #374151;
            margin: 0.5rem 0;
        }

        .tags {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #4b5563;
        }

        .link {
            display: block;
            margin-top: 0.5rem;
            color: #2563eb;
            text-decoration: none;
        }

        .month-year {
            font-weight: bold;
            margin: 1rem 0;
            color: #374151;
        }
    </style>
</head>

<body>
    <h1>Research Updates</h1>
    <div id="filter-container">
        <label for="tag-filter">Filter by tag:</label>
        <select id="tag-filter" onchange="filterByTag()">
            <option value="all">All</option>
        </select>
    </div>
    <div id="timeline" class="timeline">Loading updates...</div>

    <script>
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ28g90tYQKcq5QnRJULaYVLjm4lwZqfL-nVVtAhACY9JbgIMhSrlMMgNFHQCm3wUEXfdxOR8IRBB6D/pub?gid=0&single=true&output=csv';

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function formatMonthYear(dateString) {
            const options = { year: 'numeric', month: 'long' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function createCard(data) {
            const card = document.createElement('div');
            card.className = 'card';
            const bulletPoints = data.Description.split('.,').map(item => `<li>${item.trim()}</li>`).join('');
            const tags = data.Tags.split(',').map(tag => `<span class='hashtag' onclick='filterTimeline("${tag.trim()}")'>#${tag.trim()}</span>`).join(' ');
            card.innerHTML = `
                <h3>${data.Headline}</h3>
                <h4>${data['Short text']}</h4>
                <p><strong>Date:</strong> ${formatDate(data.Date)}</p>
                <ul>${bulletPoints}</ul>
                <div class="tags">${tags}</div>
                <p><a href="${data.Link}" target="_blank">Read more</a></p>
            `;
            return card;
        }

        function populateTagFilter(tags) {
            const filter = document.getElementById('tag-filter');
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                filter.appendChild(option);
            });
        }

        function filterByTag() {
            const selectedTag = document.getElementById('tag-filter').value;
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                const cardTags = card.querySelector('.tags').textContent;
                if (selectedTag === 'all' || cardTags.includes(`#${selectedTag}`)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function loadTimeline() {
            try {
                const response = await fetch(sheetUrl);
                const csv = await response.text();

                Papa.parse(csv, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        const data = results.data;

                        // Sort by Date descending
                        data.sort((a, b) => new Date(b.Date) - new Date(a.Date));

                        const timeline = document.getElementById('timeline');
                        timeline.innerHTML = '';

                        let lastMonthYear = '';
                        const allTags = new Set();

                        data.forEach(entry => {
                            const currentMonthYear = formatMonthYear(entry['Date']);

                            if (currentMonthYear !== lastMonthYear) {
                                const monthYearLabel = document.createElement('div');
                                monthYearLabel.className = 'month-year';
                                monthYearLabel.textContent = currentMonthYear;
                                timeline.appendChild(monthYearLabel);
                                lastMonthYear = currentMonthYear;
                            }

                            const card = createCard(entry);
                            timeline.appendChild(card);

                            // Collect tags
                            entry.Tags.split(',').forEach(tag => allTags.add(tag.trim()));
                        });

                        populateTagFilter(Array.from(allTags).sort());
                    },
                    error: function (err) {
                        console.error('Parsing error:', err);
                    }
                });
            } catch (err) {
                console.error('Fetch or parsing failed:', err);
                document.getElementById('timeline').innerText = 'Failed to load updates.';
            }
        }

        loadTimeline();
    </script>
</body>

</html>