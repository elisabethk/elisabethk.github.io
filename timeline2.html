<!DOCTYPE html>
<html>
<head>
  <title>LC / ME Clinical Trials Watchlist</title>
  <style>
    :root {
      --bg: #0c0c0f;              /* very dark base */
      --bg-alt: #08080a;           /* darker edge */
      --surface: #151518;          /* subtle dark surfaces */
      --surface-2: #1a1a1d;        /* slightly lighter headers */
      --border: rgba(255,255,255,0.04);
      --border-soft: rgba(255,255,255,0.02);
      --shadow: rgba(0, 0, 0, 0.3);
      --text: #f5f5f7;
      --muted-text: #a8a8aa;
      --accent: #059669;          /* darker emerald green accent */
      --accent-2: #10b981;        /* medium emerald */
      --link: #10b981;
      --link-hover: #34d399;
      /* Clinical trial gradients - harmonious blue, purple, green */
      --p2-start: rgba(59, 130, 246, 0.32);    /* soft blue */
      --p2-end:   rgba(59, 130, 246, 0.16);
      --p23-start: rgba(139, 92, 246, 0.30);   /* purple */
      --p23-end:   rgba(139, 92, 246, 0.15);
      --p3-start: rgba(34, 197, 94, 0.28);     /* emerald green */
      --p3-end:   rgba(34, 197, 94, 0.14);
      --bar-border: rgba(255,255,255,0.06);
      --bar-shadow: rgba(0, 0, 0, 0.2);
      /* Milestone */
      --milestone-bg: rgba(168, 168, 170, 0.15);
      --milestone-border: rgba(168, 168, 170, 0.4);
      --milestone-text: #a8a8aa;
    }
    body {
      background: radial-gradient(1400px 900px at 15% 0%, var(--surface) 0%, var(--bg) 55%, var(--bg-alt) 100%);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "SF Pro Display", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 32px 40px 40px 40px;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h2 {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "SF Pro Display", Helvetica, Arial, sans-serif;
      font-size: 2.25em;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin: 0 0 24px 0;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }
    #loading { font-size: 18px; color: var(--muted-text); }
    #error { color: #fca5a5; font-size: 16px; font-weight: 500; }
    .filter-container {
      margin: 0 0 20px 0;
      padding: 16px 20px;
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 4px 20px var(--shadow);
      border: 1px solid var(--border);
      display: inline-block;
      color: var(--muted-text);
      backdrop-filter: blur(10px);
    }
    .filter-toggle { display: flex; align-items: center; gap: 10px; }
    .toggle-switch { position: relative; display: inline-block; width: 44px; height: 18px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(21, 21, 24, 0.8); transition: all .3s ease; border-radius: 999px; border: 1px solid var(--border);
    }
    .slider:before {
      position: absolute; content: ""; height: 16px; width: 16px; left: 1px; bottom: 1px;
      background: var(--bg); border: 1px solid var(--border-soft); transition: all .3s ease; border-radius: 50%;
      box-shadow: 0 2px 4px var(--shadow);
    }
    input:checked + .slider { background: rgba(5, 150, 105, 0.2); border-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(26px); background: var(--accent); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
    .filter-label { color: var(--muted-text); font-size: 15px; font-weight: 500; }
    .table-wrapper {
      margin-top: 0; box-shadow: 0 4px 20px var(--shadow); border-radius: 16px; background: var(--surface);
      padding: 0px; position: relative; display: flex; overflow: hidden; border: none;
      backdrop-filter: blur(15px);
    }
    .frozen-column {
      width: 200px; min-width: 200px; background: var(--surface);
      z-index: 100; box-shadow: 1px 0 0 var(--border-soft); border-right: 1px solid var(--border-soft);
    }
    .scrollable-content { flex: 1; overflow-x: auto; max-width: calc(100vw - 280px); }
    .frozen-table, .main-table { width: 100%; border-collapse: collapse; background: transparent; color: var(--text); font-size: 0.95em; table-layout: fixed; }
    .frozen-table { width: 200px; }
    .frozen-table th, .frozen-table td {
      width: 200px; padding: 8px 12px; text-align: left; border-right: 1px solid var(--border-soft); border-bottom: 1px solid var(--border-soft); background: transparent; height: 32px; vertical-align: middle; box-sizing: border-box;
    }
    .frozen-table th { background: var(--surface-2); color: var(--muted-text); font-weight: 600; border-bottom: 1px solid var(--border-soft); }
    .frozen-table td { background: var(--surface); color: var(--text); font-weight: 600; }
    .main-table th, .main-table td {
      border-right: 1px solid var(--border-soft); border-bottom: 1px solid var(--border-soft); padding: 3px 2px; text-align: center; min-width: 16px; max-width: 20px; position: relative; font-size: 0.95em; background: transparent; height: 32px; vertical-align: middle; box-sizing: border-box;
    }
    .main-table th { background: var(--surface-2); color: var(--muted-text); font-weight: 600; border-bottom: 1px solid var(--border-soft); }
    /* Subtle bar tones */
    .phase2 { background: linear-gradient(90deg, var(--p2-start) 0%, var(--p2-end) 100%); color: var(--text); box-shadow: 0 1px 3px var(--bar-shadow); border: 1px solid var(--bar-border); }
    .phase23 { background: linear-gradient(90deg, var(--p23-start) 0%, var(--p23-end) 100%); color: var(--text); box-shadow: 0 1px 3px var(--bar-shadow); border: 1px solid var(--bar-border); }
    .phase3 { background: linear-gradient(90deg, var(--p3-start) 0%, var(--p3-end) 100%); color: var(--text); box-shadow: 0 1px 3px var(--bar-shadow); border: 1px solid var(--bar-border); }
    .milestone {
      width: 16px; height: 16px; font-size: 0.85em; background: var(--milestone-bg); color: var(--milestone-text) !important;
      font-weight: 700; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 1px 3px var(--bar-shadow); border: 1px solid var(--milestone-border);
    }
    .today-marker { width: 18px; height: 18px; line-height: 18px; font-size: 1.8em; color: #a8a8aa !important; display: inline-block; cursor: pointer; position: absolute; left: 50%; top: 2px; transform: translateX(-50%); z-index: 10; text-shadow: 0 0 10px rgba(168, 168, 170, 0.25); }
    .continuous-bar { height: 18px; border-radius: 8px; width: 100%; position: absolute; left: 0; top: 0; z-index: 1; opacity: 1; box-shadow: 0 2px 6px var(--bar-shadow); }
    .bar-cell { position: relative; padding: 0; border: none; background: transparent; vertical-align: middle; }
    .bar-cell .continuous-bar { top: 50%; transform: translateY(-50%); }
    .bar-cell .milestone { top: 50%; transform: translateY(-50%); }
    .empty-cell { background: transparent !important; border-right: 1px solid var(--border-soft); border-bottom: 1px solid var(--border-soft); }
    .year-divider { position: absolute; top: 0; bottom: 0; left: 0; width: 0; pointer-events: none; z-index: 0; }
    .year-divider-inner { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; transform: translateX(-50%); background: var(--border); border-radius: 0; box-shadow: none; z-index: 0; pointer-events: none; border: none; }
    /* Ensure timeline renders above the divider overlay */
    .main-table { position: relative; z-index: 2; }
    /* Overlay container for year dividers */
    #year-dividers { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 0; }
    .legend {
      margin-top: 24px; background: var(--surface); color: var(--text); border-radius: 16px; padding: 16px 20px; font-size: 15px; display: inline-block; box-shadow: 0 4px 20px var(--shadow); border: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .legend-item { display: inline-flex; align-items: center; margin-right: 20px; margin-bottom: 8px; gap: 8px; vertical-align: top; }
    .legend-bar { display: inline-block; width: 24px; height: 12px; border-radius: 6px; box-shadow: 0 1px 3px var(--bar-shadow); flex-shrink: 0; border: 1px solid var(--bar-border); }
    .legend-phase2 { background: linear-gradient(90deg, var(--p2-start) 0%, var(--p2-end) 100%); }
    .legend-phase23 { background: linear-gradient(90deg, var(--p23-start) 0%, var(--p23-end) 100%); }
    .legend-phase3 { background: linear-gradient(90deg, var(--p3-start) 0%, var(--p3-end) 100%); }
    .legend-star { display: inline-block; width: 16px; height: 16px; line-height: 16px; font-size: 0.9em; background: var(--milestone-bg); color: var(--milestone-text); border-radius: 50%; text-align: center; font-weight: 700; box-shadow: 0 1px 3px var(--bar-shadow); border: 1px solid var(--milestone-border); flex-shrink: 0; }
    .legend-sun { display: inline-block; width: 18px; height: 18px; line-height: 18px; font-size: 0.9em; color: #a8a8aa; text-align: center; flex-shrink: 0; text-shadow: 0 0 4px rgba(168, 168, 170, 0.25); }
    a { color: var(--link); text-decoration: underline; transition: color 0.2s; }
    a:hover { color: var(--link-hover); text-decoration: underline; }
    .main-table td.year-odd { background: rgba(255,255,255,0.03); }
    .main-table td.year-even { background: rgba(255,255,255,0.02); }
  </style>
</head>
<body>
  <h2>LC / ME Clinical Trials Watchlist</h2>
  <div id="loading">Loading data...</div>
  <div id="error" style="display:none"></div>
  
  <div class="filter-container" id="filter_container" style="display:none">
    <div class="filter-toggle">
      <span class="filter-label">Starred only:</span>
      <label class="toggle-switch">
        <input type="checkbox" id="star_filter">
        <span class="slider"></span>
      </label>
      <span class="filter-label" style="margin-left:18px;">LC</span>
      <input type="checkbox" id="lc_filter" style="accent-color: var(--accent); width:18px; height:18px;">
      <span class="filter-label" style="margin-left:12px;">ME</span>
      <input type="checkbox" id="me_filter" style="accent-color: var(--accent-2); width:18px; height:18px;">
    </div>
  </div>
  
  <div class="table-wrapper" id="table_wrapper" style="display:none">
    <div class="frozen-column">
      <table class="frozen-table" id="frozen_table"></table>
    </div>
    <div class="scrollable-content">
      <div style="position:relative;">
        <table class="main-table" id="main_table"></table>
        <div id="year-dividers"></div>
      </div>
    </div>
  </div>
  
  <div class="legend">
    <span class="legend-item"><span class="legend-bar legend-phase2"></span>Phase 2</span>
    <span class="legend-item"><span class="legend-bar legend-phase23"></span>Phase 2/3</span>
    <span class="legend-item"><span class="legend-bar legend-phase3"></span>Phase 3</span>
    <span class="legend-item"><span class="legend-star">&#9733;</span>Primary completion date</span>
    <span class="legend-item"><span class="legend-sun">☀️</span>Today</span>
  </div>
  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSnTg3Oy4cTr7XQERGyaIECozT0JyY4jj3V6n90ys5hMA99tJTCkwJ9Bd3st3Nw8NwUbKdLjpOTWJtv/pub?gid=0&single=true&output=csv';
    let allTrials = []; // Store all trials for filtering

    function parseDate(str) {
      if (!str) return null;
      let d = new Date(str);
      if (isNaN(d)) {
        let parts = str.split('/');
        if (parts.length === 3) {
          return new Date(parts[2], parts[0]-1, parts[1]);
        }
        return null;
      }
      return d;
    }

    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('table_wrapper').style.display = 'none';
      document.getElementById('filter_container').style.display = 'none';
      let err = document.getElementById('error');
      err.innerText = msg;
      err.style.display = '';
    }

    function getMonthKey(date) {
      return date.getFullYear() + '-' + String(date.getMonth()+1).padStart(2, '0');
    }

    function getMonthLabel(date) {
      return date.toLocaleString('default', { month: 'short' }) + ' ' + date.getFullYear();
    }

    function phaseClass(phase) {
      if (phase === 'Phase 2') return 'phase2';
      if (phase === 'Phase 2/3') return 'phase23';
      if (phase === 'Phase 3') return 'phase3';
      return '';
    }

    // Robust CSV parser for quoted fields
    function parseCSVLine(line) {
      const regex = /("([^"]|"")*"|[^,]*)(,|$)/g;
      let cols = [];
      let match;
      while ((match = regex.exec(line)) !== null) {
        let val = match[1];
        if (val.startsWith('"') && val.endsWith('"')) {
          val = val.slice(1, -1).replace(/""/g, '"');
        }
        cols.push(val.trim());
        if (match[3] === '') break;
      }
      return cols;
    }

    function isStarred(trial) {
      return trial['Star'] && trial['Star'].toLowerCase() === 'x';
    }
    function isLC(trial) {
      return trial['LC'] && trial['LC'].toLowerCase() === 'x';
    }
    function isME(trial) {
      return trial['ME'] && trial['ME'].toLowerCase() === 'x';
    }

    function alignTableRows() {
      // Force row height alignment after tables are rendered
      setTimeout(() => {
        const frozenRows = document.querySelectorAll('#frozen_table tbody tr');
        const mainRows = document.querySelectorAll('#main_table tbody tr');
        
        // Ensure both tables have the same number of rows
        const minRows = Math.min(frozenRows.length, mainRows.length);
        
        for (let i = 0; i < minRows; i++) {
          const frozenRowHeight = frozenRows[i].offsetHeight;
          const mainRowHeight = mainRows[i].offsetHeight;
          const maxHeight = Math.max(frozenRowHeight, mainRowHeight);
          
          // Set both rows to the same height
          frozenRows[i].style.height = maxHeight + 'px';
          mainRows[i].style.height = maxHeight + 'px';
        }
        
        // Also align header rows
        const frozenHeaders = document.querySelectorAll('#frozen_table thead tr');
        const mainHeaders = document.querySelectorAll('#main_table thead tr');
        
        for (let i = 0; i < Math.min(frozenHeaders.length, mainHeaders.length); i++) {
          const frozenHeaderHeight = frozenHeaders[i].offsetHeight;
          const mainHeaderHeight = mainHeaders[i].offsetHeight;
          const maxHeaderHeight = Math.max(frozenHeaderHeight, mainHeaderHeight);
          
          frozenHeaders[i].style.height = maxHeaderHeight + 'px';
          mainHeaders[i].style.height = maxHeaderHeight + 'px';
        }
      }, 50); // Small delay to ensure DOM is fully rendered
    }

    function syncScroll() {
      const frozenTable = document.getElementById('frozen_table');
      const mainTable = document.getElementById('main_table');
      const scrollableContent = document.querySelector('.scrollable-content');

      if (!frozenTable || !scrollableContent) return;

      // Sync vertical scroll between tables
      const scrollHandler = function() {
        frozenTable.style.transform = `translateY(-${this.scrollTop}px)`;
      };
      
      scrollableContent.addEventListener('scroll', scrollHandler);
    }

    // Draw thick yellow dividers between each year segment
    function drawYearDividers() {
      const dividersContainer = document.getElementById('year-dividers');
      const wrapper = dividersContainer ? dividersContainer.parentElement : null; // the relative container
      const yearHeaders = document.querySelectorAll('#main_table thead tr:first-child th');
      if (!dividersContainer || !wrapper || !yearHeaders.length) return;

      // Clear existing dividers
      dividersContainer.innerHTML = '';

      const wrapperRect = wrapper.getBoundingClientRect();

      // Place a divider at each boundary between years (exclude the very first left edge)
      for (let i = 0; i < yearHeaders.length - 1; i++) {
        const thisRect = yearHeaders[i].getBoundingClientRect();
        const boundaryX = thisRect.right - wrapperRect.left; // boundary between year i and i+1

        const divider = document.createElement('div');
        divider.className = 'year-divider';
        divider.style.left = boundaryX + 'px';

        const inner = document.createElement('div');
        inner.className = 'year-divider-inner';
        divider.appendChild(inner);

        dividersContainer.appendChild(divider);
      }
    }

    function drawTable(trials) {
      if (!trials.length) {
        document.getElementById('table_wrapper').innerHTML = '<div style="color: var(--muted-text); padding: 20px; text-align: center;">No trials match the current filter.</div>';
        return;
      }

      trials.sort((a, b) => parseDate(a['PC']) - parseDate(b['PC']));

      // Find min/max month for columns, but start at Jan 2025
      let minDate = new Date(2025, 0, 1); // Jan 2025
      let maxDate = null;
      trials.forEach(trial => {
        let e = parseDate(trial['End']);
        if (!maxDate || e > maxDate) maxDate = e;
      });

      // Get current date
      const today = new Date();

      // Build month keys from Jan 2025 to maxDate
      let months = [];
      let d = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
      let end = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
      while (d <= end) {
        months.push(getMonthKey(d));
        d.setMonth(d.getMonth() + 1);
      }

      // Group months by year and quarter, always 3 months per quarter
      let grouped = {};
      months.forEach(mk => {
        let [year, m] = mk.split('-');
        let monthNum = parseInt(m, 10);
        let q = Math.floor((monthNum - 1) / 3) + 1;
        if (!grouped[year]) grouped[year] = {1: [], 2: [], 3: [], 4: []};
        grouped[year][q].push(mk);
      });

      // Ensure each quarter has 3 months (fill with empty placeholders if needed)
      Object.keys(grouped).forEach(year => {
        for (let q = 1; q <= 4; q++) {
          while (grouped[year][q].length < 3) {
            grouped[year][q].push(''); // Add empty string for missing months
          }
        }
      });

      // Build frozen column table (interventions)
      let frozenHtml = '<thead>';
      frozenHtml += '<tr><th>Intervention</th></tr>';
      frozenHtml += '<tr><th></th></tr>';
      frozenHtml += '</thead><tbody>';
      
      trials.forEach(trial => {
        let interventionCell;
        // Star icon or blank space (same width)
        const starIcon = isStarred(trial)
          ? '<span style="display:inline-block;width:18px;color:var(--accent);font-size:0.9em;margin-right:2px;text-align:center;">★</span>'
          : '<span style="display:inline-block;width:18px;margin-right:2px;">&nbsp;</span>';
        // No LC/ME icons
        if (trial['Link']) {
          interventionCell = `${starIcon}<a href="${trial['Link']}" target="_blank" style="color:inherit;text-decoration:underline;">${trial['Intervention']}</a>`;
        } else {
          interventionCell = `${starIcon}${trial['Intervention']}`;
        }
        frozenHtml += `<tr><td>${interventionCell}</td></tr>`;
      });
      frozenHtml += '</tbody>';

      // Build main table (timeline)
      let mainHtml = '<thead>';
      // First header row: years
      mainHtml += '<tr>';
      Object.keys(grouped).forEach(year => {
        mainHtml += `<th colspan="12" style="background: var(--surface-2); color: var(--muted-text);">${year}</th>`;
      });
      mainHtml += '</tr>';
      // Second header row: quarters
      mainHtml += '<tr>';
      Object.keys(grouped).forEach(year => {
        for (let q = 1; q <= 4; q++) {
          mainHtml += `<th colspan="3" style="background: var(--surface-2); color: var(--muted-text);">Q${q}</th>`;
        }
      });
      mainHtml += '</tr>';
      mainHtml += '</thead><tbody>';
      
      // Table rows
      trials.forEach(trial => {
        mainHtml += '<tr>';
        let start = parseDate(trial['Start']);
        let end = parseDate(trial['End']);
        let pc = parseDate(trial['PC']);
        let phase = trial['Phase'];
        let trialName = trial['Trial'];

        // Build flat months array (with empty placeholders)
        let flatMonths = [];
        let yearKeys = Object.keys(grouped);
        yearKeys.forEach(year => {
          for (let q = 1; q <= 4; q++) {
            grouped[year][q].forEach(mk => flatMonths.push({ mk, year }));
          }
        });

        // Find start/end month index in flatMonths
        let startIdx = flatMonths.findIndex(obj => {
          if (!obj.mk) return false;
          let dt = new Date(obj.mk.split('-')[0], obj.mk.split('-')[1]-1, 1);
          return dt.getFullYear() === start.getFullYear() && dt.getMonth() === start.getMonth();
        });
        let endIdx = flatMonths.findIndex(obj => {
          if (!obj.mk) return false;
          let dt = new Date(obj.mk.split('-')[0], obj.mk.split('-')[1]-1, 1);
          return dt.getFullYear() === end.getFullYear() && dt.getMonth() === end.getMonth();
        });
        let pcIdx = flatMonths.findIndex(obj => {
          if (!obj.mk) return false;
          let dt = new Date(obj.mk.split('-')[0], obj.mk.split('-')[1]-1, 1);
          return dt.getFullYear() === pc.getFullYear() && dt.getMonth() === pc.getMonth();
        });

        // Helper to get year class for a cell
        function yearClass(idx) {
          if (idx < 0 || idx >= flatMonths.length) return '';
          let year = flatMonths[idx].year;
          let yearIdx = yearKeys.indexOf(year);
          return yearIdx % 2 === 0 ? 'year-even' : 'year-odd';
        }

        // Render cells before bar
        for (let i = 0; i < startIdx; i++) {
          mainHtml += `<td class="empty-cell ${yearClass(i)}"></td>`;
        }
        // Render bar cells
        let barColspan = endIdx - startIdx + 1;
        if (barColspan > 0) {
          // All bar cells get the year class of their first cell
          let barYearClass = yearClass(startIdx);
          // Build detailed tooltip
          let tooltip = `${trialName}`;
          if (trial['Trialist'] && trial['Trialist'].trim()) {
            tooltip += `\n${trial['Trialist']}`;
          }
          tooltip += `\nStart: ${trial['Start']}`;
          tooltip += `\nEnd: ${trial['End']}`;
          tooltip += `\nPrimary Completion: ${trial['PC']}`;
          
          mainHtml += `<td class="bar-cell ${barYearClass}" colspan="${barColspan}" style="position:relative;background:transparent;">`;
          mainHtml += `<div class="continuous-bar ${phaseClass(phase)}" title="${tooltip}"></div>`;
          if (pcIdx >= startIdx && pcIdx <= endIdx) {
            let milestonePos = ((pcIdx - startIdx + 0.5) / barColspan) * 100;
            mainHtml += `<span class="milestone" title="${tooltip}" style="position:absolute; left:${milestonePos}%; top:50%; transform:translate(-50%,-50%); z-index:2;">&#9733;</span>`;
          }
          mainHtml += `</td>`;
        }
        // Render cells after bar
        for (let i = endIdx + 1; i < flatMonths.length; i++) {
          mainHtml += `<td class="empty-cell ${yearClass(i)}"></td>`;
        }
        mainHtml += '</tr>';
      });
      mainHtml += '</tbody>';

      document.getElementById('frozen_table').innerHTML = frozenHtml;
      document.getElementById('main_table').innerHTML = mainHtml;
      // Draw vertical year dividers after DOM is updated
      requestAnimationFrame(drawYearDividers);

      // Add today marker to the appropriate quarter header cell
      setTimeout(() => {
        const table = document.querySelector('#main_table');
        if (table) {
          const quarterHeaders = table.querySelectorAll('thead tr:nth-child(2) th');
          
          // Build flat months array again to find today's position
          let flatMonths = [];
          Object.keys(grouped).forEach(year => {
            for (let q = 1; q <= 4; q++) {
              grouped[year][q].forEach(mk => flatMonths.push(mk));
            }
          });
          
          // Find which quarter today falls into
          const todayMonthKey = getMonthKey(today);
          let todayQuarterIdx = -1;
          
          for (let i = 0; i < flatMonths.length; i += 3) {
            const quarterMonths = flatMonths.slice(i, i + 3);
            if (quarterMonths.includes(todayMonthKey)) {
              todayQuarterIdx = Math.floor(i / 3);
              break;
            }
          }
          
          if (todayQuarterIdx >= 0 && todayQuarterIdx < quarterHeaders.length) {
            const quarterHeader = quarterHeaders[todayQuarterIdx];
            quarterHeader.style.position = 'relative';
            const todayMarker = document.createElement('span');
            todayMarker.className = 'today-marker';
            todayMarker.innerHTML = '☀️';
            todayMarker.title = `Today (${today.toLocaleDateString()})`;
            quarterHeader.appendChild(todayMarker);
          }
        }
      }, 100);

      // Setup scroll synchronization and row alignment
      syncScroll();
      alignTableRows();

    }

    function applyFilter() {
      const showStarredOnly = document.getElementById('star_filter').checked;
      const showLCOnly = document.getElementById('lc_filter').checked;
      const showMEOnly = document.getElementById('me_filter').checked;
      let filteredTrials = allTrials;

      if (showStarredOnly) {
        filteredTrials = filteredTrials.filter(isStarred);
      }
      if (showLCOnly) {
        filteredTrials = filteredTrials.filter(isLC);
      }
      if (showMEOnly) {
        filteredTrials = filteredTrials.filter(isME);
      }
      drawTable(filteredTrials);
    }

    async function fetchAndDraw() {
      try {
        const response = await fetch(csvUrl);
        const csvText = await response.text();
        const lines = csvText.split('\n').filter(l => l.trim());
        if (!lines.length) return showError('No data found.');
        const headers = parseCSVLine(lines[0]);
        const required = ['Trial', 'Intervention', 'Start', 'PC', 'End', 'Phase'];
        const idx = {};
        required.forEach(col => { idx[col] = headers.indexOf(col); });
        if (Object.values(idx).some(i => i === -1)) return showError('Missing required columns in data.');
        
        allTrials = lines.slice(1).map(line => {
          let cols = parseCSVLine(line);
          let obj = {};
          headers.forEach((h, i) => obj[h] = (cols[i] || '').trim());
          return obj;
        }).filter(row =>
          row['Intervention'] && row['Start'] && row['End'] && row['PC'] && row['Trial']
        );
        
        if (!allTrials.length) {
          console.error('Parsed rows:', lines.slice(1).map(parseCSVLine));
          return showError('No valid data rows found.');
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('filter_container').style.display = '';
        document.getElementById('table_wrapper').style.display = '';

        // Setup filter event listeners
        document.getElementById('star_filter').addEventListener('change', applyFilter);
        document.getElementById('lc_filter').addEventListener('change', applyFilter);
        document.getElementById('me_filter').addEventListener('change', applyFilter);

        // Initial draw with all trials
        applyFilter();

      } catch (e) {
        showError('Failed to load data: ' + e);
      }
    }

    // Recompute dividers on resize to keep alignment accurate
    window.addEventListener('resize', () => requestAnimationFrame(drawYearDividers));

    fetchAndDraw();
  </script>
</body>
</html>
