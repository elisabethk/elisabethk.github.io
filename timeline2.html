<!DOCTYPE html>
<html>
<head>
  <title>LC / ME Clinical Trials Watchlist</title>
  <style>
    body {
      background: linear-gradient(135deg, #181c1f 0%, #013220 100%);
      color: #e8f5e9;
      font-family: "Segoe UI", sans-serif;
      margin: 40px;
    }
    h2 {
      color: #ffffff;
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 0.1em;
      background: linear-gradient(90deg, #ffff03 0%, #84bd73 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0px 0px #ffffff99;
    }
    #loading { font-size: 18px; color: #b2dfdb; }
    #error { color: #ffb3b3; font-size: 16px; }
    .table-wrapper {
      margin-top: .5rem;
      background: linear-gradient(135deg, #23272a 60%, #014d3b 100%);
      border-radius: 14px;
      box-shadow: 0 8px 32px #000a;
      display: flex;
      overflow: hidden;
    }
    .frozen-column { width:200px; background:#181c1f; }
    .scrollable-content { flex:1; overflow-x:auto; }

    .frozen-table, .main-table {
      border-collapse: collapse;
      color:#e8f5e9;
      font-size: .95em;
      table-layout: fixed;
    }
    .frozen-table th, .frozen-table td {
      width:200px; padding:4px 8px;
      border:1px solid #333;
      text-align:left;
    }
    .main-table th, .main-table td {
      border:1px solid #333;
      min-width:16px;
      height:30px;
      text-align:center;
      position:relative;
    }
    .main-table th {
      background:#222;
      color:#b2dfdb;
    }
    .continuous-bar {
      height:18px; border-radius:6px;
      width:100%; position:absolute;
      left:0; top:0;
      box-shadow:0 2px 8px #23272a55;
    }
    .phase2  { background:linear-gradient(90deg,#ffff66,#f7e9a0); }
    .phase23 { background:linear-gradient(90deg,#bfff00,#e6ffcc); }
    .phase3  { background:linear-gradient(90deg,#66ff66,#b2dfdb); }
    .milestone {
      position:absolute; top:0; left:50%;
      transform:translateX(-50%);
      width:16px; height:16px; line-height:16px;
      background:linear-gradient(135deg,#ffd700,#fffbe6);
      border-radius:50%;
      border:1px solid #e8f5e9;
      font-size:.9em; font-weight:bold; color:#222;
      z-index:2;
    }
    .today-marker {
      position:absolute; top:2px; left:50%;
      transform:translateX(-50%);
      font-size:1.4em; color:#fce805;
      text-shadow:0 0 6px #f0c82a88;
    }
    /* Thick year separators */
    .main-table .year-start { border-left:4px solid #ffd700 !important; }
    .main-table thead tr:first-child th.year-header:not(:first-child) {
      border-left:4px solid #ffd700 !important;
    }
  </style>
</head>
<body>
  <h2>LC / ME Clinical Trials Watchlist</h2>
  <div id="loading">Loading data...</div>
  <div id="error" style="display:none"></div>
  <div class="table-wrapper" id="table_wrapper" style="display:none">
    <div class="frozen-column"><table class="frozen-table" id="frozen_table"></table></div>
    <div class="scrollable-content"><table class="main-table" id="main_table"></table></div>
  </div>

<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSnTg3Oy4cTr7XQERGyaIECozT0JyY4jj3V6n90ys5hMA99tJTCkwJ9Bd3st3Nw8NwUbKdLjpOTWJtv/pub?gid=0&single=true&output=csv';
let allTrials=[];

function parseDate(str){ if(!str) return null; const d=new Date(str); if(!isNaN(d)) return d; return null; }
function getMonthKey(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }
function phaseClass(p){ if(p==='Phase 2')return'phase2'; if(p==='Phase 2/3')return'phase23'; if(p==='Phase 3')return'phase3'; return''; }
function parseCSVLine(l){const re=/(\"([^\"]|\"\")*\"|[^,]*)(,|$)/g;let a=[],m;while((m=re.exec(l))!==null){let v=m[1];if(v.startsWith('"')&&v.endsWith('"'))v=v.slice(1,-1).replace(/""/g,'"');a.push(v.trim());if(m[3]==='')break;}return a;}

async function drawTable(trials){
  trials.sort((a,b)=>parseDate(a['PC'])-parseDate(b['PC']));
  const minDate=new Date(2025,0,1);
  let maxDate=new Date(2025,0,1);
  trials.forEach(t=>{const e=parseDate(t['End']);if(e&&e>maxDate)maxDate=e;});
  const months=[],d=new Date(minDate);while(d<=maxDate){months.push(getMonthKey(d));d.setMonth(d.getMonth()+1);}
  const years=[...new Set(months.map(m=>m.split('-')[0]))];
  // frozen col
  let frozen='<thead><tr><th>Intervention</th></tr></thead><tbody>';
  trials.forEach(t=>{frozen+=`<tr><td>${t['Intervention']}</td></tr>`;});
  frozen+='</tbody>'; document.getElementById('frozen_table').innerHTML=frozen;
  // headers
  let main='<thead><tr>';
  years.forEach(y=>{main+=`<th colspan="12" class="year-header">${y}</th>`;}); main+='</tr><tr>';
  years.forEach(y=>{for(let q=1;q<=4;q++){const c=(q===1)?'year-start':'';main+=`<th colspan="3" class="${c}">Q${q}</th>`;}}); 
  main+='</tr></thead><tbody>';
  // rows
  trials.forEach(trial=>{
    main+='<tr>';
    const start=parseDate(trial['Start']), end=parseDate(trial['End']), pc=parseDate(trial['PC']);
    const startIdx=months.indexOf(getMonthKey(start)), endIdx=months.indexOf(getMonthKey(end)), pcIdx=months.indexOf(getMonthKey(pc));
    for(let y=0;y<years.length;y++){
      for(let m=0;m<12;m++){
        const colIdx=y*12+m;
        const atYearStart=(m===0)?'year-start':'';
        if(colIdx<startIdx||colIdx>endIdx){ main+=`<td class="${atYearStart}"></td>`; continue; }
        // find segment length until either endIdx or year end
        let segEnd=Math.min(endIdx,(y*12+11));
        const span=segEnd-colIdx+1;
        main+=`<td colspan="${span}" class="${atYearStart}" style="position:relative">`;
        main+=`<div class="continuous-bar ${phaseClass(trial['Phase'])}" title="${trial['Trial']}"></div>`;
        if(pcIdx>=colIdx && pcIdx<=segEnd){const offset=(pcIdx-colIdx+0.5)/span*100;main+=`<span class="milestone" style="left:${offset}%">&#9733;</span>`;}
        main+='</td>'; m+=span-1;
      }
    }
    main+='</tr>';
  });
  main+='</tbody>'; document.getElementById('main_table').innerHTML=main;
  // today marker
  const today=getMonthKey(new Date()), idx=months.indexOf(today);
  if(idx>=0){const qh=document.querySelectorAll('#main_table thead tr:nth-child(2) th')[Math.floor(idx/3)];if(qh){qh.style.position='relative';qh.innerHTML+='<span class="today-marker">☀️</span>';}}
  document.getElementById('loading').style.display='none';document.getElementById('table_wrapper').style.display='';
}

async function fetchAndDraw(){
  const res=await fetch(csvUrl);const txt=await res.text();const lines=txt.split('\n').filter(l=>l.trim());
  const headers=parseCSVLine(lines[0]);allTrials=lines.slice(1).map(l=>{let c=parseCSVLine(l),o={};headers.forEach((h,i)=>o[h]=c[i]||'');return o;});
  drawTable(allTrials.filter(r=>r['Intervention']));
}
fetchAndDraw();
</script>
</body>
</html>
